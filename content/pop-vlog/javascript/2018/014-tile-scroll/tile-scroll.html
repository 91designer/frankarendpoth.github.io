<!DOCTYPE html>

<html>

  <head>

    <meta charset = "utf-8">
    <meta name = "viewport" content = "width=device-width">

    <title>Tile Scroll</title>

    <style>

      * { margin:0; padding:0; }

      html, body { background-color:#000000; height:100%; position:relative; width:100%; }

      canvas { height:100%; position:fixed; width:100%; }

    </style>

  </head>

  <body>

    <canvas></canvas>

    <script type = "text/javascript">

      const Viewport = function(x, y, w, h) {

        this.h = h; this.w = w; this.x = x; this.y = y;

      };

      Viewport.prototype = {

        scrollTo:function(x, y) {

          //this.x = x - this.w * 0.5; // stiff scroll
          //this.y = y - this.h * 0.5; // stiff scroll

          this.x += (-this.x + x - this.w * 0.5) * 0.05; // smooth scroll
          this.y += (-this.y + y - this.h * 0.5) * 0.05; // smooth scroll

        }

      };

      const Player = function(x, y, w, h) {

        this.h = h; this.w = w; this.x = x; this.y = y;

      };

      Player.prototype = {

        moveTo:function(x, y) {

          this.x += (x - this.x - this.w * 0.5) * 0.05;
          this.y += (y - this.y - this.h * 0.5) * 0.05;

        }

      };

      var context = document.querySelector("canvas").getContext("2d");

      var tile_size = 32;
      var columns   = 24;
      var rows      = 24;
      var map = [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
                 3,2,1,1,0,0,3,3,3,2,1,0,3,0,0,0,3,0,0,1,2,2,2,3,
                 3,1,1,0,0,0,3,3,3,1,0,0,3,0,2,0,3,0,1,1,2,1,1,3,
                 3,0,0,0,0,0,3,3,2,0,0,0,3,0,0,0,3,1,2,2,2,1,1,3,
                 3,1,1,0,0,0,3,1,1,0,0,0,3,3,3,0,1,1,2,2,1,0,0,3,
                 3,0,0,1,2,1,3,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,3,
                 3,0,1,2,2,1,3,0,1,0,0,0,0,0,0,0,0,1,0,1,0,1,0,3,
                 3,0,0,1,1,1,3,1,1,1,0,1,0,0,0,3,0,0,3,3,3,0,0,3,
                 3,0,0,0,1,1,3,3,3,3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,
                 3,3,0,3,3,3,3,3,3,3,3,1,0,0,0,3,0,0,3,3,3,2,1,3,
                 3,3,1,0,0,1,3,3,3,3,3,0,0,0,0,0,0,1,1,0,1,1,0,3,
                 3,3,3,3,1,1,3,3,3,3,3,1,0,0,0,0,1,1,2,2,1,0,0,3,
                 3,3,3,3,0,1,0,0,3,3,1,0,0,1,1,2,1,2,0,1,2,1,0,3,
                 3,2,3,0,0,0,1,0,1,1,0,0,1,0,0,2,1,2,2,1,2,1,1,3,
                 3,1,1,1,0,0,0,0,1,1,0,0,0,1,1,0,2,1,1,1,2,0,1,3,
                 3,1,1,1,1,1,0,1,3,3,1,0,0,0,1,1,1,2,2,2,1,1,2,3,
                 3,0,0,0,1,0,1,1,3,3,1,0,0,0,0,1,0,1,1,1,1,1,1,3,
                 3,1,1,0,0,0,0,3,3,3,1,1,2,2,0,0,3,3,3,3,3,3,3,3,
                 3,0,1,0,1,0,1,3,3,3,3,2,2,2,2,1,3,1,0,0,0,0,1,3,
                 3,1,0,0,0,1,3,3,3,2,1,0,1,2,0,1,0,0,0,1,1,0,0,3,
                 3,2,0,0,0,0,3,3,3,3,1,1,0,1,1,0,3,0,1,2,2,1,0,3,
                 3,3,1,0,1,1,3,3,3,3,3,3,0,0,1,1,3,0,0,1,1,0,0,3,
                 3,3,1,1,2,3,3,3,3,3,3,3,1,0,1,2,3,1,0,0,0,0,1,3,
                 3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3];


      var height = document.documentElement.clientHeight;
      var width = document.documentElement.clientWidth;

      var player = new Player(columns * 0.5 * tile_size, rows * 0.5 * tile_size, 32, 32);

      var viewport = new Viewport(0, 0, tile_size * 10, tile_size * 10);

      var pointer = { x:columns * 0.5 * tile_size, y:rows * 0.5 * tile_size };

      function loop() {

        window.requestAnimationFrame(loop);

        height = document.documentElement.clientHeight;
        width = document.documentElement.clientWidth;

        context.canvas.height = height;
        context.canvas.width = width;
        context.imageSmoothingEnabled = false;

        player.moveTo(pointer.x, pointer.y);
        viewport.scrollTo(player.x + player.w * 0.5, player.y + player.h * 0.5);

        var x_min = Math.floor(viewport.x / tile_size);
        var y_min = Math.floor(viewport.y / tile_size);
        var x_max = Math.ceil((viewport.x + viewport.w) / tile_size);
        var y_max = Math.ceil((viewport.y + viewport.h) / tile_size);

        if (x_min < 0) x_min = 0;
        if (y_min < 0) y_min = 0;
        if (x_max > columns) x_max = columns;
        if (y_max > rows) y_max = rows;

        for (let x = x_min; x < x_max; x ++) {

          for (let y = y_min; y < y_max; y ++ ) {

            let value = map[y * columns + x];

            let tile_x = Math.round(x * tile_size - viewport.x + width * 0.5 - viewport.w * 0.5);
            let tile_y = Math.round(y * tile_size - viewport.y + height * 0.5 - viewport.h * 0.5);

            context.drawImage(image, value * 16, 0, 16, 16, tile_x, tile_y, tile_size, tile_size);

          }

        }

        let player_index = Math.floor((player.y + player.h * 0.5) / tile_size) * columns + Math.floor((player.x + player.w * 0.5) / tile_size);

        if (map[player_index] == 2) map[player_index] = 1;

        context.strokeStyle = "#ffffff";
        context.rect(width * 0.5 - viewport.w * 0.5, height * 0.5 - viewport.h * 0.5, viewport.w, viewport.h);
        context.stroke();

        context.drawImage(image, 64, 0, 16, 16, Math.round(player.x - viewport.x + width * 0.5 - viewport.w * 0.5), Math.round(player.y - viewport.y + height * 0.5 - viewport.h * 0.5), tile_size, tile_size);

      }

      window.addEventListener("click", (event) => {

        pointer.x = event.pageX + viewport.x - width * 0.5 + viewport.w * 0.5;
        pointer.y = event.pageY + viewport.y - height * 0.5 + viewport.h * 0.5;

      });

      var image = new Image();

      image.addEventListener("load", (event) => {

        loop();

      });

      image.src = "tile-scroll.png";

    </script>

  </body>

</html>
